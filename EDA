#EDA:

#playing around with a few different bar plots
hist(SL_data$SL_days_per_week_f)
hist(SL_data$SL_duration_f)
hist(SL_data$SL_session_affordability_a)

hist(NSL_data$NSL_not_affordable_a)

NSL_data_no_missing$NSL_not_affordable_a<- factor(NSL_data_no_missing$NSL_not_affordable_a)

ggplot(data= NSL_data_no_missing)+
  geom_bar(aes(NSL_not_affordable_a))+
  scale_x_discrete(labels = c("2"="Agree","3"="Somewhat agree", "4"="Somewhat disagree",
                              "5" = "Disagree", "6"="Strongly disagree"))+
  labs(
    title = "Affordability for families whose children aren't attending Speech Language Therapy",
    x = "Speech Language therapy services are affordable"
  )

#Creating a data frame with affordability for both SL and NSL
nsl<-c()
sl<-c()
agreement<- 1:6
for(i in 1:6){
nsl[i]<-dim(NSL_data_no_missing %>% filter(NSL_not_affordable_a==i))[1]
sl[i]<- dim(SL_data %>% filter(SL_session_affordability_a ==i))[1]
}

affordability_agreement<- data.frame(agreement,nsl,sl)
affordability_agreement<- affordability_agreement %>% pivot_longer(
                        cols=nsl:sl,
                        values_to = "frequency",
                        names_to="attends_SL"
)

affordability_agreement$frequency<- ifelse(affordability_agreement$attends_SL=="sl",
                                    (affordability_agreement$frequency/68)*100,
                                    (affordability_agreement$frequency/40)*100)

affordability_agreement<- affordability_agreement %>% rename(
                                                      Percentage = frequency
)
  
affordability_agreement$agreement <- factor(affordability_agreement$agreement)
ggplot(data = affordability_agreement, aes(agreement, Percentage,fill = attends_SL))+
  geom_bar(stat="identity", position='dodge')+
  scale_x_discrete(labels= c("1"="Strongly agree", "2"="Agree",
                             "3"="Somewhat agree","4"="Somewhat disagree",
                             "5"="Disagree", "6"="Strongly disagree"))+
  theme(axis.text.x = element_text(angle = 10, vjust = 1, hjust=0.5))+
  scale_fill_discrete(name = "Attends SL?", labels = c("No", "Yes"))+
  labs(title="Affordability's effect on Speech Language Therapy(SL) Attendance",
       x= "Can afford speech therapy sessions?")+
  theme(plot.margin = unit(c(0, 0, 0, 0), 
                           "inches"))+
  theme(plot.title = element_text(size=12),
        axis.text=element_text(size=10),
        axis.title=element_text(size=12))

#affordability vs verbal ability

ability<- data_of_int
ability$NSL_not_affordable_a[71:110]<- abs(ability$NSL_not_affordable_a[71:110]-7)
ability_affordability<- ability %>% select(Groups_Minimal_Verbal,attends_speech_therapy,
                                           SL_session_affordability_a,NSL_not_affordable_a)
afford<- rep(0,110)
afford[1:70]<- ability_affordability$SL_session_affordability_a[1:70]
afford[71:110]<- ability_affordability$NSL_not_affordable_a[71:110]

VnonV_affordability<- ability_affordability %>% mutate(
                          affordability = afford)
afford_nonVerbal<- VnonV_affordability %>% filter(Groups_Minimal_Verbal==1)
afford_Verbal <- VnonV_affordability %>% filter(Groups_Minimal_Verbal==0)


nver<-c()
ver<-c()
agreement<- 1:6
for(i in 1:6){
  nver[i]<-dim(afford_nonVerbal %>% filter(affordability==i))[1]
  ver[i]<- dim(afford_Verbal %>% filter(affordability==i))[1]
}

affordability_verbal<- data.frame(agreement,nver,ver)
affordability_verbal<- affordability_verbal %>% pivot_longer(
  cols=nver:ver,
  values_to = "frequency",
  names_to="Verbal_MinimalVerbal"
)

affordability_verbal$frequency<- ifelse(affordability_verbal$Verbal_MinimalVerbal==1,
                                           (affordability_verbal$frequency/50)*100,
                                           (affordability_verbal$frequency/60)*100)

affordability_verbal<- affordability_verbal %>% rename(
  Percentage = frequency
)

affordability_verbal$agreement <- factor(affordability_verbal$agreement)

ggplot(data = affordability_verbal, aes(agreement, Percentage,fill = Verbal_MinimalVerbal))+
  geom_bar(stat="identity", position='dodge')+
  scale_x_discrete(labels= c("1"="Strongly agree", "2"="Agree",
                             "3"="Somewhat agree","4"="Somewhat disagree",
                             "5"="Disagree", "6"="Strongly disagree"))+
  theme(axis.text.x = element_text(angle = 15, vjust = 1, hjust=0.75))+
  scale_fill_discrete(name = "Verbal Ability", labels = c("Minimally Verbal", "Verbal"))+
  labs(title="Affordability's effect on Speech Language Therapy(SL) Attendance",
       x= "Can afford speech therapy sessions?")+
  theme(plot.margin = unit(c(0, 0, 0, 0), 
                           "inches"))+
  theme(plot.title = element_text(size=12),
        axis.text=element_text(size=10),
        axis.title=element_text(size=12))



#days per week of SL vs verbal minimally verbal 

days<- data_of_int
days_SL <- c(data_of_int$SL_days_per_week_f[1:69],rep(0,41))
days<-data_of_int %>% mutate(
                          days_per_wk =days_SL+days$NSL_pre_cov_daysperwk_f
) %>% select(c(Groups_Minimal_Verbal,days_per_wk))

days_nonVerbal<- days %>% filter(Groups_Minimal_Verbal==1)
days_Verbal <- days %>% filter(Groups_Minimal_Verbal==0)


nver<-c()
ver<-c()
days<- 1:7
for(i in 1:7){
  nver[i]<-dim(days_nonVerbal %>% filter(days_per_wk==i))[1]
  ver[i]<- dim(days_Verbal %>% filter(days_per_wk==i))[1]
}


freq_verbal<- data.frame(days,nver,ver)
freq_verbal<- freq_verbal %>% pivot_longer(
  cols=nver:ver,
  values_to = "frequency",
  names_to="Verbal_MinimalVerbal"
)

freq_verbal$frequency<- ifelse(freq_verbal$Verbal_MinimalVerbal=="ver",
                                        (freq_verbal$frequency/50)*100,
                                        (freq_verbal$frequency/60)*100)

freq_verbal<- freq_verbal %>% rename(
  Percentage = frequency
) %>% arrange(desc(days))

freq_verbal$days<- abs(freq_verbal$days-7)

freq_verbal$days <- factor(freq_verbal$days) 

ggplot(data = freq_verbal, aes(days, Percentage,fill = Verbal_MinimalVerbal))+
  geom_bar(stat="identity", position='dodge')+
  geom_text(
    aes(label = paste0(round(Percentage),"%")),
    colour = "white", size = 3,
    vjust = 1.5, position = position_dodge(.9)
  )+
  scale_fill_discrete(name = "Verbal Ability", labels = c("Minimally Verbal", "Verbal"))+
  labs(title="Days/Week at Speech Language Therapy and Verbal Ability",
       x= "Days/week",
       y="Percentage of Minimal/Verbal (%)")+
  theme(plot.margin = unit(c(0, 0, 0, 0), 
                           "inches"))+
  theme(plot.title = element_text(size=12),
        axis.text=element_text(size=10),
        axis.title=element_text(size=12))+theme_minimal()+
  scale_color_discrete()

# Looking at covariances

#The first approach, I'll just look at SL and NSL separately. I can lump them together at a later stage

#SL

SL_var_data<- SL_data %>% select(SL_goals_awareness_q,
                             SL_service_quality_q,
                             SL_session_affordability_a,
                             SL_parents_can_observe_q,
                             SL_receive_home_activities_q,
                             SL_material_affordability_a,
                             ) 

corr_mat<- round(cor(SL_var_data),2)

corr_mat[upper.tri(corr_mat)]<- NA

corr_mat<- melt(corr_mat)


ggplot(data = corr_mat, aes(x=X1, y=X2, fill=value)) + 
  geom_tile(color= "white")+
  scale_fill_gradient2(low = "white", high = "#2C860D", 
                       midpoint = 0, limit = c(0,1), space = "Lab", 
                     name="Correlation")+
  theme_minimal()+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  coord_fixed()+geom_text(aes(X1,X2, label = value), color = "black", size = 3)
